<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 2.0 + PKCE Implementation - Educational Demo</title>
    <link rel="stylesheet" href="css/oauth2-demo.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-shield-alt"></i> OAuth 2.0 + PKCE Demo</h1>
            <p>Educational demonstration of OAuth 2.0 Authorization Code Flow with PKCE security enhancement</p>
        </header>

        <nav class="navigation">
            <button class="nav-btn active" data-tab="oauth2-demo">
                <i class="fas fa-sign-in-alt"></i> OAuth2 Demo
            </button>
            <button class="nav-btn" data-tab="pkce-comparison">
                <i class="fas fa-balance-scale"></i> PKCE Comparison
            </button>
            <button class="nav-btn" data-tab="security-benefits">
                <i class="fas fa-lock"></i> Security Benefits
            </button>
            <button class="nav-btn" data-tab="api-test">
                <i class="fas fa-code"></i> API Testing
            </button>
        </nav>

        <!-- OAuth2 Demo Tab -->
        <div id="oauth2-demo" class="tab-content active">
            <div class="section">
                <h2><i class="fas fa-play-circle"></i> OAuth 2.0 Authorization Flow Demo</h2>
                
                <div class="demo-steps">
                    <div class="step" id="step-1">
                        <div class="step-header">
                            <span class="step-number">1</span>
                            <h3>Generate Authorization URL</h3>
                            <button class="btn btn-primary" onclick="startOAuth2Flow()">
                                <i class="fas fa-magic"></i> Start OAuth2 Flow
                            </button>
                        </div>
                        <div class="step-content">
                            <p>Click the button above to generate a Google OAuth2 authorization URL with PKCE challenge.</p>
                            <div id="auth-url-result" class="result-box" style="display: none;"></div>
                            <div id="pkce-details" class="pkce-details" style="display: none;">
                                <h4>PKCE Details:</h4>
                                <div class="code-block">
                                    <strong>Code Verifier:</strong> <span id="code-verifier-display"></span>
                                    <button class="btn btn-sm" onclick="copyToClipboard('code-verifier-display')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="code-block">
                                    <strong>Code Challenge:</strong> <span id="code-challenge-display"></span>
                                    <button class="btn btn-sm" onclick="copyToClipboard('code-challenge-display')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step-2">
                        <div class="step-header">
                            <span class="step-number">2</span>
                            <h3>Complete Google Authorization</h3>
                        </div>
                        <div class="step-content">
                            <p>Open the authorization URL in a new window and complete the Google OAuth2 flow.</p>
                            <div class="manual-steps">
                                <ol>
                                    <li>Copy the authorization URL from the result above</li>
                                    <li>Open it in a new browser tab/window</li>
                                    <li>Sign in with your Google account</li>
                                    <li>Grant the requested permissions</li>
                                    <li>You'll be redirected to a callback URL</li>
                                    <li>Copy the <code>code</code> parameter from the URL</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="step" id="step-3">
                        <div class="step-header">
                            <span class="step-number">3</span>
                            <h3>Exchange Code for Tokens</h3>
                        </div>
                        <div class="step-content">
                            <div class="input-group">
                                <label for="authorization-code">Authorization Code:</label>
                                <input type="text" id="authorization-code" placeholder="Paste the authorization code here">
                                <button class="btn btn-success" onclick="exchangeCodeForTokens()">
                                    <i class="fas fa-exchange-alt"></i> Exchange Code
                                </button>
                            </div>
                            <div id="token-result" class="result-box" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="step" id="step-4">
                        <div class="step-header">
                            <span class="step-number">4</span>
                            <h3>Access Protected Resources</h3>
                        </div>
                        <div class="step-content">
                            <p>Now that you have access tokens, try accessing protected resources:</p>
                            <div class="action-buttons">
                                <button class="btn btn-info" onclick="getUserProfile()">
                                    <i class="fas fa-user"></i> Get User Profile
                                </button>
                                <button class="btn btn-info" onclick="getUserDashboard()">
                                    <i class="fas fa-tachometer-alt"></i> Get Dashboard
                                </button>
                                <button class="btn btn-warning" onclick="refreshAccessToken()">
                                    <i class="fas fa-sync"></i> Refresh Token
                                </button>
                            </div>
                            <div id="api-result" class="result-box" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PKCE Comparison Tab -->
        <div id="pkce-comparison" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-balance-scale"></i> PKCE vs Standard OAuth2</h2>
                
                <div class="comparison-grid">
                    <div class="comparison-card without-pkce">
                        <h3><i class="fas fa-times-circle"></i> Without PKCE (Vulnerable)</h3>
                        <div class="attack-scenario">
                            <h4>Authorization Code Interception Attack</h4>
                            <div class="attack-steps">
                                <div class="attack-step">
                                    <span class="step-icon">1</span>
                                    <p>User clicks malicious app authorization link</p>
                                </div>
                                <div class="attack-step">
                                    <span class="step-icon">2</span>
                                    <p>User authenticates on legitimate OAuth2 provider</p>
                                </div>
                                <div class="attack-step">
                                    <span class="step-icon">3</span>
                                    <p>Attacker intercepts the authorization code</p>
                                </div>
                                <div class="attack-step">
                                    <span class="step-icon">4</span>
                                    <p>Attacker exchanges code for tokens using their own app</p>
                                </div>
                                <div class="attack-step">
                                    <span class="step-icon">5</span>
                                    <p>Attacker gains unauthorized access to user resources</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-card with-pkce">
                        <h3><i class="fas fa-check-circle"></i> With PKCE (Secure)</h3>
                        <div class="pkce-protection">
                            <h4>PKCE Protection Mechanism</h4>
                            <div class="protection-steps">
                                <div class="protection-step">
                                    <span class="step-icon">1</span>
                                    <p>Client generates cryptographically secure code verifier</p>
                                </div>
                                <div class="protection-step">
                                    <span class="step-icon">2</span>
                                    <p>Client derives code challenge from verifier using S256</p>
                                </div>
                                <div class="protection-step">
                                    <span class="step-icon">3</span>
                                    <p>Authorization request includes code challenge</p>
                                </div>
                                <div class="protection-step">
                                    <span class="step-icon">4</span>
                                    <p>Attacker intercepts authorization code but cannot generate valid challenge</p>
                                </div>
                                <div class="protection-step">
                                    <span class="step-icon">5</span>
                                    <p>Token exchange fails because attacker cannot prove they initiated the request</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="live-demo">
                    <h3><i class="fas fa-flask"></i> Live PKCE Generation Demo</h3>
                    <button class="btn btn-primary" onclick="generatePKCEDemo()">
                        <i class="fas fa-magic"></i> Generate PKCE Challenge
                    </button>
                    <div id="pkce-demo-result" class="result-box" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Security Benefits Tab -->
        <div id="security-benefits" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-lock"></i> Security Benefits of PKCE</h2>
                
                <div class="benefits-grid">
                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Authorization Code Interception Protection</h3>
                        <p>PKCE prevents attackers from intercepting authorization codes and using them to obtain access tokens.</p>
                        <div class="technical-detail">
                            <strong>How it works:</strong> The code challenge binds the authorization request to the token exchange request through cryptographic verification.
                        </div>
                    </div>

                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <h3>Public Client Security</h3>
                        <p>Enables secure OAuth2 flows for public clients (mobile, desktop, SPA) that cannot store client secrets.</p>
                        <div class="technical-detail">
                            <strong>Use case:</strong> Essential for mobile apps and browser-based applications that cannot safely store secrets.
                        </div>
                    </div>

                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <i class="fas fa-crypto"></i>
                        </div>
                        <h3>Cryptographic Binding</h3>
                        <p>Uses SHA-256 hashing to create an unbreakable link between the authorization request and token exchange.</p>
                        <div class="technical-detail">
                            <strong>Algorithm:</strong> Code challenge = base64url(SHA256(code verifier))
                        </div>
                    </div>

                    <div class="benefit-card">
                        <div class="benefit-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <h3>Stateless Security</h3>
                        <p>Provides security benefits without requiring server-side session storage or state management.</p>
                        <div class="technical-detail">
                            <strong>Advantage:</strong> Works seamlessly with distributed systems and stateless architectures.
                        </div>
                    </div>
                </div>

                <div class="implementation-guide">
                    <h3><i class="fas fa-book"></i> Implementation Guide</h3>
                    <div class="code-example">
                        <h4>JavaScript PKCE Implementation</h4>
                        <pre><code>// Generate code verifier
function generateCodeVerifier() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let result = '';
    const randomValues = new Uint8Array(128);
    crypto.getRandomValues(randomValues);
    
    for (let i = 0; i < 128; i++) {
        result += chars[randomValues[i] % chars.length];
    }
    return result;
}

// Generate code challenge
async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return base64urlEncode(hash);
}

function base64urlEncode(arrayBuffer) {
    const bytes = new Uint8Array(arrayBuffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Testing Tab -->
        <div id="api-test" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-code"></i> API Testing Console</h2>
                
                <div class="token-info">
                    <h3>Current Token Status</h3>
                    <div id="token-status" class="status-box">
                        <p>No active tokens. Please complete the OAuth2 flow first.</p>
                    </div>
                </div>

                <div class="api-endpoints">
                    <h3>Available Endpoints</h3>
                    <div class="endpoint-grid">
                        <div class="endpoint-card">
                            <h4>Public Endpoints</h4>
                            <button class="btn btn-secondary" onclick="testEndpoint('/api/public/info')">
                                <i class="fas fa-info-circle"></i> GET /api/public/info
                            </button>
                            <button class="btn btn-secondary" onclick="testEndpoint('/health')">
                                <i class="fas fa-heartbeat"></i> GET /health
                            </button>
                        </div>

                        <div class="endpoint-card">
                            <h4>Protected Endpoints</h4>
                            <button class="btn btn-primary" onclick="testEndpoint('/api/user/profile')" disabled>
                                <i class="fas fa-user"></i> GET /api/user/profile
                            </button>
                            <button class="btn btn-primary" onclick="testEndpoint('/api/user/dashboard')" disabled>
                                <i class="fas fa-tachometer-alt"></i> GET /api/user/dashboard
                            </button>
                        </div>

                        <div class="endpoint-card">
                            <h4>Admin Endpoints</h4>
                            <button class="btn btn-warning" onclick="testEndpoint('/api/admin/dashboard')" disabled>
                                <i class="fas fa-cog"></i> GET /api/admin/dashboard
                            </button>
                            <button class="btn btn-warning" onclick="testEndpoint('/api/admin/oauth2-stats')" disabled>
                                <i class="fas fa-chart-bar"></i> GET /api/admin/oauth2-stats
                            </button>
                        </div>
                    </div>
                </div>

                <div class="request-response">
                    <h3>Request/Response Details</h3>
                    <div id="request-details" class="code-block"></div>
                    <div id="response-details" class="code-block"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <script src="js/oauth2-client.js"></script>
    <script src="js/pkce-helper.js"></script>
    <script src="js/demo-ui.js"></script>
</body>
</html>